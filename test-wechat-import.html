<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯•å¾®ä¿¡å…¬ä¼—å·æ‰¹é‡å¯¼å…¥</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #fafafa;
    }
    .container {
      background: white;
      padding: 30px;
      border: 2px solid #000;
    }
    h1 {
      margin: 0 0 20px;
      font-size: 24px;
    }
    .status {
      padding: 15px;
      margin: 15px 0;
      background: #f5f5f5;
      border-left: 4px solid #0066ff;
      font-family: monospace;
      font-size: 13px;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    button {
      padding: 12px 24px;
      background: #000;
      color: white;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #0066ff;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .progress {
      margin: 20px 0;
      padding: 15px;
      background: #fff8e1;
      border: 2px solid #ffc107;
    }
    .progress-bar {
      width: 100%;
      height: 30px;
      background: white;
      border: 2px solid #000;
      margin: 10px 0;
    }
    .progress-fill {
      height: 100%;
      background: #0066ff;
      transition: width 0.3s;
    }
    .results {
      margin-top: 20px;
      padding: 15px;
      background: #e8f5e9;
      border: 2px solid #4caf50;
    }
    .error {
      background: #ffebee;
      border: 2px solid #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª å¾®ä¿¡å…¬ä¼—å·æ‰¹é‡å¯¼å…¥æµ‹è¯•</h1>

    <div>
      <p><strong>biz:</strong> Mzg3MzE1MjIyNQ==</p>
      <p><strong>Cookie:</strong> å·²é…ç½®ï¼ˆéšç§ä¿æŠ¤ï¼‰</p>
    </div>

    <div style="margin: 20px 0;">
      <button id="testBtn" onclick="testImport()">ğŸš€ å¼€å§‹æµ‹è¯•</button>
      <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div id="progress" class="progress" style="display: none;">
      <p><strong>è¿›åº¦:</strong> <span id="progressText">0 / 0</span></p>
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
      </div>
      <p><strong>æˆåŠŸ:</strong> <span id="successCount">0</span> | <strong>å¤±è´¥:</strong> <span id="failedCount">0</span></p>
    </div>

    <div id="status" class="status"></div>

    <div id="results" style="display: none;"></div>
  </div>

  <script>
    const BIZ = 'Mzg3MzE1MjIyNQ==';
    const COOKIE = 'rewardsn=; wxtokenkey=777; ua_id=fKufICv322tNuSrUAAAAAOcysEp-bkZa3KByIggfyv8=; mm_lang=zh_CN; RK=O9UpCu+WF/; ptcz=a7f4954065e4972ee9040d92c0272a7e4f060afcf12fe45f8a31b58e232ef492; pac_uid=0_S4dJdFE1d7dAX; _qimei_uuid42=1920c16130c100f9a18eaeeecf8621c0686a1e2a0a; _qimei_fingerprint=299f8225cc1dde2b31459391578d9884; _qimei_h38=086d9012a18eaeeecf8621c00300000de1920c; _qimei_q36=; pgv_pvid=1742152439774474; pgv_info=ssid=s1745253697674474; uuid=59fa798e4acd847d41c1d54d1c79ca05; wxuin=51991538482818; xid=8e27ae05b5bb866982a59ac8493dbd65; _clck=3873152225|1|fxg|0';

    const CORS_PROXY = 'https://wechat-proxy.lucca-caolu.workers.dev/?url=';

    function log(message) {
      const statusDiv = document.getElementById('status');
      const timestamp = new Date().toLocaleTimeString();
      statusDiv.textContent += `[${timestamp}] ${message}\n`;
      statusDiv.scrollTop = statusDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('status').textContent = '';
      document.getElementById('results').style.display = 'none';
      document.getElementById('progress').style.display = 'none';
    }

    function updateProgress(current, total, success, failed) {
      const progressDiv = document.getElementById('progress');
      progressDiv.style.display = 'block';

      document.getElementById('progressText').textContent = `${current} / ${total}`;
      document.getElementById('successCount').textContent = success;
      document.getElementById('failedCount').textContent = failed;

      const percent = total > 0 ? (current / total) * 100 : 0;
      document.getElementById('progressFill').style.width = percent + '%';
    }

    async function testImport() {
      const testBtn = document.getElementById('testBtn');
      testBtn.disabled = true;
      clearLog();

      try {
        log('ğŸš€ å¼€å§‹æµ‹è¯•å¾®ä¿¡å…¬ä¼—å·æ‰¹é‡å¯¼å…¥');
        log(`ğŸ“ biz: ${BIZ}`);
        log(`ğŸ”‘ Cookie: å·²é…ç½®`);
        log('');

        // æ­¥éª¤1: æ„å»º URL
        const profileUrl = `https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=${encodeURIComponent(BIZ)}`;
        log(`ğŸ“„ æ„å»ºå†å²æ¶ˆæ¯é¡µé¢ URL:`);
        log(`   ${profileUrl}`);
        log('');

        // æ­¥éª¤2: é€šè¿‡ä»£ç†è·å– HTML
        log('â³ æ­£åœ¨é€šè¿‡ CORS ä»£ç†è·å–å†å²æ¶ˆæ¯é¡µé¢...');
        const proxyUrl = CORS_PROXY + encodeURIComponent(profileUrl);

        const response = await fetch(proxyUrl, {
          method: 'GET',
          headers: {
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
            'Cookie': COOKIE
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const html = await response.text();
        log(`âœ… æˆåŠŸè·å– HTMLï¼Œé•¿åº¦: ${html.length.toLocaleString()} å­—ç¬¦`);
        log('');

        // æ­¥éª¤3: è§£æ msgList
        log('ğŸ” æ­£åœ¨è§£æ msgList æ•°æ®...');
        const msgListMatch = html.match(/var\s+msgList\s*=\s*'([^']+)'/i) ||
                            html.match(/var\s+msgList\s*=\s*"([^"]+)"/i);

        if (!msgListMatch) {
          log('âŒ æœªæ‰¾åˆ° msgList æ•°æ®');
          log('');
          log('ğŸ’¡ å¯èƒ½åŸå› :');
          log('   1. Cookie å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–');
          log('   2. è¯¥å…¬ä¼—å·éœ€è¦å…³æ³¨åæ‰èƒ½æŸ¥çœ‹');
          log('   3. å¾®ä¿¡è¿”å›äº†ç™»å½•é¡µé¢');

          // ä¿å­˜ HTML ä»¥ä¾›è°ƒè¯•
          const blob = new Blob([html], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          log('');
          log(`ğŸ“¥ å·²ä¿å­˜ HTML ä¾›è°ƒè¯•: <a href="${url}" download="wechat-response.html">ä¸‹è½½æŸ¥çœ‹</a>`);
          return;
        }

        // è§£ç  msgList
        const msgListStr = msgListMatch[1]
          .replace(/&#39;/g, "'")
          .replace(/&quot;/g, '"')
          .replace(/&amp;/g, '&')
          .replace(/&lt;/g, '<')
          .replace(/&gt;/g, '>');

        const msgList = JSON.parse(msgListStr);

        log(`âœ… æˆåŠŸè§£æ msgList`);
        log(`   æ¶ˆæ¯æ•°é‡: ${msgList.list ? msgList.list.length : 0}`);
        log('');

        // æ­¥éª¤4: æå–æ–‡ç« é“¾æ¥
        log('ğŸ“‘ æ­£åœ¨æå–æ–‡ç« é“¾æ¥...');
        const articleLinks = new Set();

        if (msgList && msgList.list) {
          msgList.list.forEach((item, index) => {
            // ä¸»æ–‡ç« 
            if (item.app_msg_ext_info && item.app_msg_ext_info.content_url) {
              const link = 'https://mp.weixin.qq.com' + item.app_msg_ext_info.content_url.replace(/&amp;/g, '&');
              articleLinks.add(link);
            }

            // å¤šå›¾æ–‡
            if (item.app_msg_ext_info && item.app_msg_ext_info.multi_app_msg_item_list) {
              item.app_msg_ext_info.multi_app_msg_item_list.forEach(subItem => {
                if (subItem.content_url) {
                  const link = 'https://mp.weixin.qq.com' + subItem.content_url.replace(/&amp;/g, '&');
                  articleLinks.add(link);
                }
              });
            }
          });
        }

        const links = Array.from(articleLinks);
        log(`âœ… æå–å®Œæˆï¼Œå…±æ‰¾åˆ° ${links.length} ç¯‡æ–‡ç« `);
        log('');

        // æ˜¾ç¤ºå‰10ä¸ªé“¾æ¥ä½œä¸ºç¤ºä¾‹
        log('ğŸ“‹ æ–‡ç« é“¾æ¥ç¤ºä¾‹ï¼ˆå‰10ä¸ªï¼‰:');
        links.slice(0, 10).forEach((link, i) => {
          log(`   ${i + 1}. ${link.substring(0, 80)}...`);
        });
        log('');

        // æ­¥éª¤5: æ˜¾ç¤ºç»“æœ
        const resultsDiv = document.getElementById('results');
        resultsDiv.className = 'results';
        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = `
          <h3>âœ… æµ‹è¯•æˆåŠŸï¼</h3>
          <p><strong>æ‰¾åˆ°æ–‡ç« æ•°é‡:</strong> ${links.length} ç¯‡</p>
          <p><strong>å…¬ä¼—å· biz:</strong> ${BIZ}</p>
          <p><strong>ä¸‹ä¸€æ­¥:</strong></p>
          <ol>
            <li>åœ¨åº”ç”¨ä¸­æ‰“å¼€"æ–‡é£åº“ç®¡ç†"é¡µé¢</li>
            <li>é€‰æ‹©"æ–¹æ³•1ï¼šbiz + Cookie"</li>
            <li>å¡«å…¥ biz å’Œ cookie</li>
            <li>ç‚¹å‡»"æ‰¹é‡å¯¼å…¥"æŒ‰é’®</li>
          </ol>
        `;

        log('ğŸ‰ æµ‹è¯•å®Œæˆï¼å¯ä»¥å¼€å§‹æ‰¹é‡å¯¼å…¥äº†ã€‚');

      } catch (error) {
        log(`âŒ é”™è¯¯: ${error.message}`);
        log('');
        log('ğŸ“Š é”™è¯¯è¯¦æƒ…:');
        log(`   åç§°: ${error.name}`);
        log(`   æ¶ˆæ¯: ${error.message}`);
        if (error.stack) {
          log(`   å †æ ˆ: ${error.stack.split('\n')[0]}`);
        }

        const resultsDiv = document.getElementById('results');
        resultsDiv.className = 'results error';
        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = `
          <h3>âŒ æµ‹è¯•å¤±è´¥</h3>
          <p><strong>é”™è¯¯:</strong> ${error.message}</p>
          <p><strong>å¯èƒ½åŸå› :</strong></p>
          <ul>
            <li>Cookie å·²è¿‡æœŸ</li>
            <li>CORS ä»£ç†æ— æ³•ä¼ é€’ Cookie</li>
            <li>ç½‘ç»œé—®é¢˜</li>
          </ul>
          <p><strong>å»ºè®®:</strong> ä½¿ç”¨"æ–¹æ³•2ï¼šç²˜è´´ HTML æºä»£ç "</p>
        `;
      } finally {
        testBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
